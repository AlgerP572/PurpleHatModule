
function CanvasJSDataAsCSV(chart, fileName, buttonCsv) {
    
    var buttonCsv = document.getElementById(buttonCsv);
    buttonCsv.addEventListener("click", function () {
        parseCSV({
            filename: (fileName || "chart-data") + ".csv",
            chart: chart
        })
    });
}

function convertChartDataToCSV(args) {
    var data;
   
    data = args.data.datasets || null;
    if (data == null || !data.length) {
        return null;
    }
    
    var headers = data.map((i) => i.label);
    headers.splice(0, 0, "x");
    console.log(headers);

    var values = [];

    // all datasets should have the same number of points.   
    for(var i = 0; i < args.data.datasets[0].data.length; i++)
    {
        var row = [];        
        row.push(args.data.datasets[0].data[i].x);
        for(var j = 0; j < args.data.datasets.length; j++)
        {
            if(args.data.datasets[j].data.length > i)
            {
                row.push(args.data.datasets[j].data[i].y);
            }
            else
            {
                // the speed table column only has 28 so fill in as invalid value in csv.
                row.push("");
            }
        }
        values.push(row);
    }
    console.log(values);

    var csv = Papa.unparse({
        "fields": headers,
        "data": values
    });
    console.log(csv);
    return csv;
}

function parseCSV(args) {
    var csv = "";
    
    csv += convertChartDataToCSV({
        data: args.chart.config.data
    });

    if (csv == null) return;
    var filename = args.filename || 'chart-data.csv';
    if (!csv.match(/^data:text\/csv/i)) {
        csv = 'data:text/csv;charset=utf-8,' + csv;
    }
    downloadFile(csv, filename);
}

function downloadFile(extData, filename) {
    var data = encodeURI(extData);
    var link = document.createElement('a');
    link.setAttribute('href', data);
    link.setAttribute('download', filename);
    document.body.appendChild(link); // Required for FF
    link.click();
    document.body.removeChild(link);
}